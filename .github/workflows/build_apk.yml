name: Build APK (Buildozer)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-apk:
    runs-on: ubuntu-latest
    timeout-minutes: 300
    permissions:
      contents: read
      actions: read
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Java 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'
          cache: 'gradle'

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Update apt cache
        run: |
          sudo apt-get update
          sudo apt-get upgrade -y

      - name: Install system dependencies
        run: |
          sudo apt-get install -y --no-install-recommends \
            build-essential \
            git \
            libffi-dev \
            libssl-dev \
            libjpeg-dev \
            libpng-dev \
            libsdl2-dev \
            libsdl2-image-dev \
            libsdl2-mixer-dev \
            libsdl2-ttf-dev \
            libsqlite3-dev \
            libzbar0 \
            libbz2-dev \
            liblzma-dev \
            zlib1g-dev \
            unzip \
            wget

      - name: Install Python dependencies
        run: |
          python3 -m pip install --upgrade pip
          python3 -m pip install --upgrade setuptools wheel
          python3 -m pip install --upgrade cython==0.29.34
          python3 -m pip install --upgrade buildozer

      - name: Create buildozer cache directory
        run: mkdir -p ~/.buildozer

      - name: Display buildozer version
        run: buildozer --version

      - name: Build APK
        env:
          P4A_RELEASE_DATE: 2024010100
          GRADLE_OPTS: -Dorg.gradle.jvmargs=-Xmx4096m
          ANDROID_HOME: /home/runner/android-home
        run: |
          export JAVA_HOME=${JAVA_HOME_17_X64}
          export PATH=$JAVA_HOME/bin:$PATH
          java -version
          buildozer -v android debug 2>&1
          
      - name: List build outputs
        if: always()
        run: |
          echo "=== Checking bin directory ===" 
          ls -lah bin/ || echo "bin/ not found"
          echo "=== Checking .buildozer ===" 
          du -sh ~/.buildozer || echo ".buildozer not found"

      - name: Upload APK artifact
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: taj-al-itqan-apk
          path: |
            bin/*.apk
            bin/*.aab
          retention-days: 30
          if-no-files-found: warn
          
      - name: Log full buildozer output
        if: always()
        run: |
          echo "=== Full Directory Listing ===" 
          find . -name "*.apk" -o -name "*.aab" 2>/dev/null | head -20
          echo "" 
          echo "=== .buildozer Status ===" 
          ls -lah ~/.buildozer 2>/dev/null | head -20 || echo ".buildozer not accessible"
          echo ""
          echo "=== bin directory ===" 
          ls -lah bin/ 2>/dev/null || echo "bin/ not found"
